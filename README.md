
# üìú ‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå PostgreSQL ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå SQL ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤ E-Commerce, ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á, ‡πÅ‡∏•‡∏∞‡∏£‡∏±‡∏ô Query ‡∏ó‡∏µ‡πà‡∏ã‡∏±‡∏ö‡∏ã‡πâ‡∏≠‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏´‡∏≤ **‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ 3 ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡πÅ‡∏£‡∏Å‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏¢‡∏≠‡∏î‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡πÉ‡∏ô‡∏õ‡∏µ 2024** ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ö **‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏û‡∏ß‡∏Å‡πÄ‡∏Ç‡∏≤‡∏ä‡∏∑‡πà‡∏ô‡∏ä‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î**

---

## ‚öôÔ∏è ‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏° (Prerequisites)
1.  **PostgreSQL Server**: ‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ PostgreSQL ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡∏ö‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
2.  **Client Tool**: ‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• PostgreSQL ‡πÄ‡∏ä‡πà‡∏ô:
    * `psql`: ‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏° Command-line ‡∏ó‡∏µ‡πà‡∏°‡∏≤‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á PostgreSQL
    * **pgAdmin**: ‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡πÅ‡∏ö‡∏ö GUI (Graphical User Interface) ‡∏ó‡∏µ‡πà‡∏ô‡∏¥‡∏¢‡∏°‡πÉ‡∏ä‡πâ‡∏Å‡∏±‡∏ô

---

## üöÄ ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô

### ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 1: ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå
‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÇ‡∏Ñ‡πâ‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡∏ô‡∏µ‡πâ ‡πÅ‡∏•‡∏∞‡∏ô‡∏≥‡πÑ‡∏õ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö

```sql
-- ========= Section 1: CREATE TABLES =========
-- ‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏Å‡πà‡∏≤ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÉ‡∏´‡∏°‡πà
DROP TABLE IF EXISTS Order_Items, Orders, Products, Categories, Customers CASCADE;

-- 1.1 ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
CREATE TABLE Customers (
    customer_id SERIAL PRIMARY KEY,
    first_name VARCHAR(100) NOT NULL,
    last_name VARCHAR(100) NOT NULL,
    registration_date DATE NOT NULL DEFAULT CURRENT_DATE
);

-- 1.2 ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
CREATE TABLE Categories (
    category_id INT PRIMARY KEY,
    category_name VARCHAR(255) NOT NULL UNIQUE
);

-- 1.3 ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
CREATE TABLE Products (
    product_id INT PRIMARY KEY,
    product_name VARCHAR(255) NOT NULL,
    category_id INT NOT NULL,
    price DECIMAL(10, 2) NOT NULL CHECK (price >= 0),
    CONSTRAINT fk_category
        FOREIGN KEY(category_id)
        REFERENCES Categories(category_id)
);

-- 1.4 ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠
CREATE TABLE Orders (
    order_id INT PRIMARY KEY,
    customer_id INT NOT NULL,
    order_date DATE NOT NULL,
    status VARCHAR(50),
    CONSTRAINT fk_customer
        FOREIGN KEY(customer_id)
        REFERENCES Customers(customer_id)
);

-- 1.5 ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠
CREATE TABLE Order_Items (
    order_item_id SERIAL PRIMARY KEY,
    order_id INT NOT NULL,
    product_id INT NOT NULL,
    quantity INT NOT NULL CHECK (quantity > 0),
    price_per_unit DECIMAL(10, 2) NOT NULL,
    CONSTRAINT fk_order
        FOREIGN KEY(order_id)
        REFERENCES Orders(order_id),
    CONSTRAINT fk_product
        FOREIGN KEY(product_id)
        REFERENCES Products(product_id)
);

-- ========= Section 2: INSERT DATA =========
-- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á
INSERT INTO Customers (customer_id, first_name, last_name, registration_date) VALUES
(1, 'Somchai', 'Jaidee', '2023-01-15'),
(2, 'Somsri', 'Rakdee', '2023-02-20'),
(3, 'Mana', 'Petch', '2023-03-10'),
(4, 'Malee', 'Klinhom', '2024-01-05');

INSERT INTO Categories (category_id, category_name) VALUES
(101, 'Electronics'), (102, 'Books'), (103, 'Clothing'), (104, 'Home & Kitchen');

INSERT INTO Products (product_id, product_name, category_id, price) VALUES
(1, 'Laptop', 101, 35000.00), (2, 'Smartphone', 101, 22000.00), (3, 'SQL Guide', 102, 750.00),
(4, 'T-Shirt', 103, 400.00), (5, 'Coffee Maker', 104, 2500.00);

INSERT INTO Orders (order_id, customer_id, order_date, status) VALUES
(1001, 1, '2024-02-10', 'completed'), (1002, 2, '2024-03-15', 'completed'),
(1003, 1, '2024-04-20', 'completed'), (1004, 3, '2024-05-01', 'completed'),
(1005, 2, '2024-06-12', 'completed'), (1006, 4, '2024-07-22', 'completed'),
(1007, 1, '2025-01-05', 'completed'); -- Order ‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏ô‡∏≠‡∏Å‡∏õ‡∏µ 2024 ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏á

INSERT INTO Order_Items (order_id, product_id, quantity, price_per_unit) VALUES
(1001, 1, 1, 35000.00), (1001, 3, 2, 750.00), (1002, 2, 1, 22000.00),
(1002, 4, 5, 400.00), (1003, 4, 10, 400.00), (1004, 5, 1, 2500.00),
(1005, 1, 1, 35000.00), (1006, 3, 3, 750.00);

-- ‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤ sequence ‡∏Ç‡∏≠‡∏á SERIAL ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å manual insert
SELECT setval('customers_customer_id_seq', (SELECT MAX(customer_id) FROM Customers));
SELECT setval('order_items_order_item_id_seq', (SELECT MAX(order_item_id) FROM Order_Items));

-- ========= Section 3: CREATE INDEXES =========
-- ‡∏™‡∏£‡πâ‡∏≤‡∏á Index ‡∏ö‡∏ô Foreign Keys ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏ö‡πà‡∏≠‡∏¢‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤/JOIN ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß
CREATE INDEX idx_products_category_id ON Products(category_id);
CREATE INDEX idx_orders_customer_id ON Orders(customer_id);
CREATE INDEX idx_orders_order_date ON Orders(order_date); -- ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö WHERE clause
CREATE INDEX idx_order_items_order_id ON Order_Items(order_id);
CREATE INDEX idx_order_items_product_id ON Order_Items(product_id);

-- ========= Section 4: THE HEAVY QUERY =========
-- Query ‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
WITH
  SalesIn2024 AS (
    SELECT o.customer_id, p.category_id, oi.quantity * oi.price_per_unit AS total_item_price
    FROM Order_Items AS oi
    JOIN Orders AS o ON oi.order_id = o.order_id
    JOIN Products AS p ON oi.product_id = p.product_id
    WHERE EXTRACT(YEAR FROM o.order_date) = 2024
  ),
  CustomerTotalSpending AS (
    SELECT customer_id, SUM(total_item_price) AS total_spent_2024
    FROM SalesIn2024
    GROUP BY customer_id
  ),
  CategorySpendingPerCustomer AS (
    SELECT s.customer_id, c.category_name, SUM(s.total_item_price) AS category_spent
    FROM SalesIn2024 AS s
    JOIN Categories AS c ON s.category_id = c.category_id
    GROUP BY s.customer_id, c.category_name
  ),
  RankedCategorySpending AS (
    SELECT customer_id, category_name, category_spent,
           RANK() OVER (PARTITION BY customer_id ORDER BY category_spent DESC) AS category_rank
    FROM CategorySpendingPerCustomer
  )
SELECT
  c.first_name, c.last_name,
  cts.total_spent_2024,
  rcs.category_name AS top_category,
  rcs.category_spent AS spent_in_top_category
FROM RankedCategorySpending AS rcs
JOIN CustomerTotalSpending AS cts ON rcs.customer_id = cts.customer_id
JOIN Customers AS c ON rcs.customer_id = c.customer_id
WHERE rcs.category_rank = 1
ORDER BY cts.total_spent_2024 DESC
LIMIT 3;
